# JVM调优——编译器优化

# 前言

> Java程序从源文件创建到程序运行要经过两大步骤：
>
> 1、源文件由编译器编译成字节码（ByteCode）    2、字节码由java虚拟机解释运行。
>
> 字节码是无法再JVM中直接运行的，必须经过jvm解释器或者编译器变成本地的机器码，才能运行。我们这一节主要就是讲解这个过程，因为一般来说，java程序既要编译也要经过JVM的解释运行，所以说Java被称为半解释语言.

![img](https://img-blog.csdnimg.cn/20190228181804580.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyMzIyMTAz,size_16,color_FFFFFF,t_70)

## 解释VS编译

* 解释执行
  * 需要一个解释器，它会将我们的一句句解释成机器代码来执行，可以认为是，解释一句，执行一句。在这个过程中，不会生成中间文件。
  * 不论在Server模式还是Client模式，解释器只有一个。
  * 优势在于没有编译的等待时间，对于执行次数少的代码性能相对好一些，但是如果此段代码经常执行就需要不断的解释（因为没有编译成本地机器代码），从而影响性能
* 编译执行
  * 编译执行，顾名思义，要先编译再执行，这里需要有一个编译器，来将我们的代码全部编译成机器代码，然后进行执行。因为先整体进行编译，所以这里会生成编译后的机器代码。
  * 运行效率会高很多（后期直接运行机器代码）,一般认为比解释执行快一个数量级
  * 带来了额外的开销
* 查看jvm的运行模式
  * java -version
    * mixed mode(默认为混合模式)
    * interpreted mode 解释执行
    * compiled mode 编译执行模式
* 如何改变JVM运行模式
  * -Xint：设置JVM的执行模式为解释执行模式 
  * -Xcomp:JVM优先以编译模式运行,不能编译的,以解释模式运行。

## 什么是 JIT ？

为了提高热点代码的执行效率，在运行时，虚拟机将会把这些代码编译成与本地平台相关的机器码，并进行各种层次的优化，完成这个任务的编译器称为即时编译器（Just In Time Compiler），简称 JIT 编译器

## HotSpot是如何运行class字节码文件的

一开始一般由解释器逐行解释执行

当虚拟机发现某个方法或代码块的运行特别频繁的时候,就会认为这些代码是**“热点代码”**。为了提高热点代码的执行效率，会用即时编译器(也就是JIT)把这些热点代码编译成与本地平台相关的**机器码**,并进行各层次的化

## HotSpot的即时编译器

* C1编译器
  * 是一个简单快速的编译器
  * 主要关注局部性的优化
  * 适用于执行时间较短或对启动性能有要求的程序。例如,GUI
  * 应用对界面启动速度就有一定要求。
  * 也被称为是 Client Compiler
* C2编译器
  * 

代码的一般编译过程

## 分层编译

0：单纯的解释执行

1：解释执行 + 简单C1编译：会用C1编译器进行一些简单的优化,不开启 Profiling（JVM的性能监控）

2：解释执行 + 受限的C1编译:仅执行带**方法调用次数**以及**循环回边执行次数**Profiling的C1编译

3：解释执行 + 完全C1编译：会执行带有所有 Profiling的C1代码

4：解释执行 + C2编译：使用C2编译器进行优化，该级别会启用一些编译耗时较长的优化,一些情況下会根据性能监控信息进行一些非常激进的性能优化

级别越高,应用启动越慢,优化的开销越高,峰值性能也越高。