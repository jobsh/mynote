# Java类加载过程



<img src="http://typicture.loopcode.online/image/image-20210408205412947.png" alt="image-20210408205412947" style="zoom: 67%;" />

> 我们谈到类加载，一般就是指的是编译好的class文件的生命周期，而不是单纯指class文件加载到虚拟机这一个过程，而是以下所有过程的统称。
>
> 这些过程包括：加载、验证、准备、解析、初始化、使用和卸载这些过程，其中加载、验证、准备、初始化、使用这5个阶段的顺序是确定的，类的加载过程必须按照这种顺序进行，而解析阶段则不一定，它在某些情况下可能在初始化阶段后在开始，因为java支持运行时绑定。
>
> 其中**验证、准备、解析**通常又被合在一起称为**连接**过程。

## 加载

查找并加载类文件的二进制数据，在加载阶段，虚拟机会做以下三件事情：

1. 通过类的全限定名来获取定义此类的class文件
2. 将类的静态存储结构转换成方法区中运行时常量池中的数据结构
3. 在内存中生成一个代表该类java.lang.Class对象，作为方法区这个类信息的访问入口

## 链接

将已经读取入内存的类的二进制数据合并到JVM运行时环境中，包括以下几个步骤

### 验证

验证是链接阶段的第一步，主要目的就是为了**确保class文件的正确性**，保证class文件中包含的信息符合JVM虚拟机的要求并且不会危害到虚拟机自身安全。主要包含以下四种类型的验证：

1. **文件格式验证**：验证class文件是否符合规范，例如文件的开头是否以ca fe ba be开头
2. **元数据验证**：对字节码描述的信息进行语义分析，确保其描述的信息符合Java语法要求
3. **字节码验证**：对类的方法体进行校验，保证方法在运行期间不会危害到虚拟机的安全
4. **符号引用验证**：对类自身以外的信息进行匹配行校验

对以上几种验证了解即可。

### 准备

准备是链接阶段中最重要的一环，前面说到**加载阶段**的时，会将**类的静态存储结构存放到方法**区，而准备阶段实际上就是为**类的变量分配内存并设置类变量的初始默认值(零值)**，如int类型的静态变量就会在此时初始化默认值为0，而真正的**赋值**这是在初始化阶段。

**注意**：上述的类变量指的是被static修饰的变量，但不包含final关键字修饰的static变量，因为final修饰的在编译的时候就已经分配了内存。

如`private static int a = 5`，由于a是静态变量，且不失常量，因此在准备阶段会对变量a分配内存，并设置初始值0。而a = 5的赋值是在后续的初始化阶段完成的。

### 解析

解析阶段就是常量池中的符号引用转换成直接引用的过程。解析动作主要正对类或接口、字段、类方法、接口方法、方法类型等。事实上，解析动作往往伴随着虚拟机执行初始化之后才执行。

## 初始化

